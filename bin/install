#!/usr/bin/env bash
set -euo pipefail

version="${ASDF_INSTALL_VERSION}"
install_dir="${ASDF_INSTALL_PATH}"
download_dir="${ASDF_DOWNLOAD_PATH}"

asset="$(cat "${download_dir}/.asset_name")"
file="${download_dir}/${asset}"

if [[ ! -f "$file" ]]; then
  echo "Error: ${file} not found. Run download first." >&2
  exit 1
fi

mkdir -p "${install_dir}/bin"

case "${asset}" in
  *.deb)
    dpkg-deb -x "$file" "$install_dir"
    if [[ -f "${install_dir}/usr/bin/handy" ]]; then
      ln -sf "${install_dir}/usr/bin/handy" "${install_dir}/bin/handy"
    elif [[ -f "${install_dir}/usr/bin/Handy" ]]; then
      ln -sf "${install_dir}/usr/bin/Handy" "${install_dir}/bin/handy"
    fi
    ;;
  *.app.tar.gz)
    tar xzf "$file" -C "$install_dir"
    handy_bin=$(find "$install_dir" -type f -name "Handy" -path "*/MacOS/*" | head -1)
    if [[ -n "$handy_bin" ]]; then
      ln -sf "$handy_bin" "${install_dir}/bin/handy"
      chmod +x "$handy_bin"
    fi
    ;;
  *)
    echo "Error: unknown asset format: ${asset}" >&2; exit 1 ;;
esac

if [[ ! -e "${install_dir}/bin/handy" ]]; then
  echo "Error: could not find handy binary after extraction" >&2
  find "$install_dir" -type f >&2
  exit 1
fi

chmod +x "${install_dir}/bin/handy"

desktop_src=$(find "$install_dir" -name "*.desktop" -path "*/applications/*" | head -1)
if [[ -n "$desktop_src" ]]; then
  desktop_dir="${HOME}/.local/share/applications"
  mkdir -p "$desktop_dir"
  handy_real=$(readlink -f "${install_dir}/bin/handy")
  cp "$desktop_src" "${desktop_dir}/handy.desktop"
  sed -i "s|^Exec=.*|Exec=${handy_real}|" "${desktop_dir}/handy.desktop"
  icon_src=$(find "$install_dir" -name "handy.png" -path "*/128x128/*" | head -1)
  if [[ -n "$icon_src" ]]; then
    sed -i "s|^Icon=.*|Icon=${icon_src}|" "${desktop_dir}/handy.desktop"
  fi
  echo "Desktop entry installed to ${desktop_dir}/handy.desktop"
fi

echo "Handy v${version} installed to ${install_dir}"
